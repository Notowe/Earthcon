const $=async(u,C,O=2)=>{var w,x;const c=u.width,s=u.height,m=document.createElement("canvas");m.width=c,m.height=s;const e=m.getContext("2d");if(!e)throw new Error("Could not get 2D context for screenshot composition");if(e.drawImage(u,0,0),(w=C.postProcessing)!=null&&w.enabled){const t=C.postProcessing,f=(t.opacity??100)/100,I=5;let g="";if(t.brightnessEnabled){const a=(t.brightnessIntensity??100)/100*f;if(t.brightness!==100){const n=100+(t.brightness-100)*I*a;g+=` brightness(${Math.max(0,n)}%)`}if(t.contrast!==100){const n=100+(t.contrast-100)*a;g+=` contrast(${n}%)`}}if(t.hueEnabled){const a=(t.hueIntensity??100)/100*f;if(t.hue!==0){const n=t.hue*3.6*a;g+=` hue-rotate(${n}deg)`}if(t.saturation!==10){const o=100+(t.saturation*10-100)*I*a;g+=` saturate(${Math.max(0,o)}%)`}}if(g){const a=document.createElement("canvas");a.width=c,a.height=s;const n=a.getContext("2d");n&&(n.drawImage(m,0,0),e.clearRect(0,0,c,s),e.save(),e.filter=g,e.drawImage(a,0,0),e.restore())}if(t.bloomEnabled&&t.bloom>0){const a=(t.bloomStrength??2.7)*((t.bloom??100)/100),n=(t.bloomRadius??1)*12*(O||1);t.bloomThreshold;const o=document.createElement("canvas");o.width=c/4,o.height=s/4;const i=o.getContext("2d");if(i){i.drawImage(m,0,0,o.width,o.height),i.filter=`blur(${n/4}px) brightness(${a*100}%) contrast(150%)`;const r=document.createElement("canvas");r.width=o.width,r.height=o.height,(x=r.getContext("2d"))==null||x.drawImage(m,0,0,r.width,r.height),i.clearRect(0,0,o.width,o.height),i.filter=`blur(${n/4}px) brightness(${a*50+50}%)`,i.drawImage(r,0,0),e.save(),e.globalCompositeOperation="screen",e.globalAlpha=.6,e.drawImage(o,0,0,c,s),e.restore()}}if(t.dofEnabled&&t.blur>0){const a=t.blur/5*f,n=t.fstop??30;t.focus;const o=50,i=t.focalLat?50:t.focus??50,r=Math.max(0,n/2),h=Math.max(r+10,n),l=document.createElement("canvas");l.width=c,l.height=s;const d=l.getContext("2d");if(d){d.filter=`blur(${a}px)`,d.drawImage(m,0,0);const R=r/100*s,S=h/100*s,y=o/100*c,E=i/100*s,b=document.createElement("canvas");b.width=c,b.height=s;const p=b.getContext("2d");if(p){const v=p.createRadialGradient(y,E,R,y,E,S);v.addColorStop(0,"rgba(0,0,0,0)"),v.addColorStop(1,"rgba(0,0,0,1)"),p.fillStyle=v,p.fillRect(0,0,c,s)}d.globalCompositeOperation="destination-in",d.drawImage(b,0,0),e.save(),e.globalCompositeOperation="source-over",e.globalAlpha=1,e.drawImage(l,0,0),e.restore()}}if(t.mosaicEnabled&&t.mosaic>0){const a=Math.max(1,t.mosaicSize||10),n=t.mosaic/100*((t.opacity??100)/100),o=1/(a/2),i=Math.ceil(c*o),r=Math.ceil(s*o),h=document.createElement("canvas");h.width=i,h.height=r;const l=h.getContext("2d");l&&(l.drawImage(m,0,0,i,r),e.save(),e.globalAlpha=n,e.imageSmoothingEnabled=!1,e.drawImage(h,0,0,c,s),e.restore())}if(t.chromaticEnabled&&t.chromatic>0){const a=(t.chromaticOffsetX??15)*((t.chromatic??0)/100),n=(t.chromaticOffsetY??15)*((t.chromatic??0)/100),o=(t.chromatic??0)/100*((t.opacity??100)/100);(a!==0||n!==0)&&(e.save(),e.globalCompositeOperation="screen",e.globalAlpha=o,e.restore())}if(t.noiseEnabled){const a=(t.noiseAmount??36)/100,n=(t.noiseIntensity??100)/100*((t.opacity??100)/100),o=document.createElement("canvas");o.width=c,o.height=s;const i=o.getContext("2d");if(i){const r=i.createImageData(c,s),h=r.data;for(let l=0;l<h.length;l+=4){const d=Math.random()*255;h[l]=d,h[l+1]=d,h[l+2]=d,h[l+3]=255}i.putImageData(r,0,0),e.save(),e.globalCompositeOperation="overlay",e.globalAlpha=a*n,e.drawImage(o,0,0),e.restore()}}if(t.vignetteEnabled){const a=(t.vignetteIntensity??100)/100*f,n=t.vignetteOffset??50,o=(t.vignetteDarkness??80)/100,i=e.createRadialGradient(c/2,s/2,n/100*(s/2),c/2,s/2,s*.8);i.addColorStop(0,"rgba(0,0,0,0)"),i.addColorStop(1,`rgba(0,0,0,${o})`),e.save(),e.globalCompositeOperation="source-over",e.globalAlpha=a,e.fillStyle=i,e.fillRect(0,0,c,s),e.restore()}}return m.toDataURL("image/png",1)};export{$ as generateCompositeImage};
